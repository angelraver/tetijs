<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
body {
	background: black;
	text-align: center;
}
canvas {
	margin: 1% auto;
	border:1px solid #d3d3d3;
	background-color: #ccc;
}
button {
	display: block;
	margin: 0 auto;
}
</style>
</head>
<body onload="">
<button onclick="stop()" >Stop!</button>
<button onclick="go()" >Go!</button>

<script>
const BLOCK_UNITY = 20;
const FORMS = [
	{
		id: 'S',
		pieces: [
			{
				order: 1,
				blocks: [
					{ r: 1, c: 1 },
					{ r: 2, c: 1 },
					{ r: 2, c: 2 },
					{ r: 3, c: 2 }
				]
			},
			{
				order: 2,
				blocks: [
					{ r: 1, c: 2 },
					{ r: 1, c: 3 },
					{ r: 2, c: 1 },
					{ r: 2, c: 2 }
				]
			}
		]
	},
	{
		id: 'Z',
		pieces: [
			{
				order: 1,
				blocks: [
					{ r: 1, c: 2 },
					{ r: 2, c: 1 },
					{ r: 2, c: 2 },
					{ r: 3, c: 1 }
				]
			},
			{
				order: 2,
				blocks: [
					{ r: 1, c: 1 },
					{ r: 1, c: 2 },
					{ r: 2, c: 2 },
					{ r: 2, c: 3 }
				]
			}
		]
	},
	{
		id: 'I',
		pieces: [
			{
				order: 1,
				blocks: [
					{ r: 1, c: 2 },
					{ r: 2, c: 2 },
					{ r: 3, c: 2 },
					{ r: 4, c: 2 }
				]
			},
			{
				order: 2,
				blocks: [
					{ r: 2, c: 1 },
					{ r: 2, c: 2 },
					{ r: 2, c: 3 },
					{ r: 2, c: 4 }
				]
			}
		]
	},
	{
		id: 'O',
		pieces: [
			{
				order: 1,
				blocks:[
					{ r: 1, c: 1 },
					{ r: 1, c: 2 },
					{ r: 2, c: 1 },
					{ r: 2, c: 2 },
					]
			}
		]
	},
	{
		id: 'L',
		pieces: [
			{
				order: 1,
				blocks: [
					{ r: 1, c: 1 },
					{ r: 2, c: 1 },
					{ r: 3, c: 1 },
					{ r: 3, c: 2 },
				]
			},
			{
				order: 2,
				blocks: [
					{ r: 1, c: 3 },
					{ r: 2, c: 1 },
					{ r: 2, c: 2 },
					{ r: 2, c: 3 }
				]
			},
			{
				order: 3,
				blocks: [
					{ r: 1, c: 2 },
					{ r: 1, c: 3 },
					{ r: 2, c: 3 },
					{ r: 3, c: 3 }
				]
			},
			{
				order: 4,
				blocks: [
					{ r: 1, c: 1 },
					{ r: 1, c: 2 },
					{ r: 1, c: 3 },
					{ r: 2, c: 1 }
				],
			}
		]
	},
	// {
	// 	id: 'LL',
	// 	pieces: [
	// 		{
	// 			order: 1,
	// 			blocks: [
	// 				{ r: 1, c: 3 },
	// 				{ r: 2, c: 3 },
	// 				{ r: 3, c: 3 },
	// 				{ r: 3, c: 2 },
	// 			]
	// 		},
	// 		{
	// 			order: 2,
	// 			blocks: [
	// 				{ r: 1, c: 1 },
	// 				{ r: 2, c: 1 },
	// 				{ r: 2, c: 2 },
	// 				{ r: 2, c: 3 }
	// 			]
	// 		},
	// 		{
	// 			order: 3,
	// 			blocks: [
	// 				{ r: 1, c: 1 },
	// 				{ r: 1, c: 2 },
	// 				{ r: 2, c: 1 },
	// 				{ r: 3, c: 1 }
	// 			]
	// 		},
	// 		{
	// 			order: 4,
	// 			blocks: [
	// 				{ r: 1, c: 1 },
	// 				{ r: 1, c: 2 },
	// 				{ r: 1, c: 3 },
	// 				{ r: 2, c: 3 }
	// 			]
	// 		}
	// 	]
	// }
];

const COLORS = ['#FF0000', '#008000', '#000080', '#FFFF00', '#800080', '#000080', '#800000'];
const GRAVITY = 1;
const GAME_SPEED = 16;
const CANVAS = document.createElement("canvas");
CANVAS.width = 200;
CANVAS.height = 400;
document.body.insertBefore(CANVAS, document.body.childNodes[0]);

var ActivePiece;
var NewPiece = true;
var AllBlocks = [];
var MoveX = 0;

const getPiece = () => {
	let form = FORMS[random(FORMS.length)];
	let formPiece = form.pieces[random(form.pieces.length)];

	return {
		id: form.id,
		x: BLOCK_UNITY * 4,
		y: -BLOCK_UNITY,
		color: COLORS[random(COLORS.length)],
		order: formPiece.order,
		blocks: formPiece.blocks
	}
}

function rolling(){
	if(NewPiece){
		ActivePiece = JSON.parse(JSON.stringify(getPiece()));
	}
	const context = CANVAS.getContext('2d');
	context.clearRect(0, 0, CANVAS.width, CANVAS.height);
	NewPiece = false;

	if(!isAtTheBottom()) {
		ActivePiece.y = ActivePiece.y + GRAVITY;
		ActivePiece.x = ActivePiece.x + MoveX;
		ActivePiece.blocks.map(function(block) {
			let x = ActivePiece.x + (block.c * 	BLOCK_UNITY);
			let y = ActivePiece.y + (block.r * 	BLOCK_UNITY);
			context.fillStyle = ActivePiece.color;
			context.fillRect(x, y, BLOCK_UNITY, BLOCK_UNITY);
		});
		MoveX = 0;
	}
	else {
		ActivePiece.blocks.map(function(block) {			
			AllBlocks.push({
				x: ActivePiece.x + (block.c * BLOCK_UNITY),
				y: ActivePiece.y + (block.r * BLOCK_UNITY),
				color: ActivePiece.color
			});
		});
		NewPiece = true;
	}

	AllBlocks.map(function(block){
		context.fillStyle = block.color;
		context.fillRect(block.x, block.y, BLOCK_UNITY, BLOCK_UNITY);
	});
}

const otherPieceX = (block) => {
	return AllBlocks.some(block2 => 
		(block.x - MoveX <= block2.x && block.y <= block2.y) ||
		(block.x + MoveX >= block2.x && block.y <= block2.y)
	);
}

const isAtTheBottom = () => {
	return ActivePiece.blocks.some(block => {
		let nextY = ActivePiece.y + (block.r * BLOCK_UNITY) + BLOCK_UNITY;
		let nextX = ActivePiece.x + (block.c * BLOCK_UNITY);
		return nextY >=  CANVAS.height ||
			AllBlocks.some(block2 => {
				return nextY >= block2.y && nextX === block2.x;
			});
	});
};

var start = setInterval(rolling, GAME_SPEED);

function go() {
	start = setInterval(rolling, GAME_SPEED);
}

function stop() {
  console.log('stop!')
  clearInterval(start);
}

function random(limit) {
  return Math.floor(Math.random() * limit);
}

const rightLimit = () => ActivePiece.blocks.some(block => ActivePiece.x + (block.c * BLOCK_UNITY) + BLOCK_UNITY >= CANVAS.width);
const leftLimit = () => ActivePiece.blocks.some(block => ActivePiece.x + (block.c * BLOCK_UNITY) <= 0);
const rightOtherPiece = () => ActivePiece.blocks.some(block => AllBlocks.some(block2 => block.x + BLOCK_UNITY >= block2.x && block.y + BLOCK_UNITY >= block2.y));
const leftOtherPiece = () => ActivePiece.blocks.some(block => AllBlocks.some(block2 => block.x - BLOCK_UNITY <= block2.x && block.y + BLOCK_UNITY >= block2.y));

function rotate() {
	if(!NewPiece) {
		let nextForm;
		FORMS.map(form => {
			if(form.id === ActivePiece.id) {
				nextForm = form;
			}
		});
		let activeOrder = ActivePiece.order;
		let maxOrder = nextForm.pieces.length;
		let nextOrder = activeOrder < maxOrder ? activeOrder + 1 : 1;

		ActivePiece.order = nextOrder;
		ActivePiece.blocks = JSON.parse(JSON.stringify(nextForm.pieces[nextOrder - 1].blocks));
	}
}

function manageKey(e) {
	switch(e.code){
		case 'ArrowRight':
			// MoveX = rightLimit() || rightOtherPiece() ? 0 : BLOCK_UNITY;
			MoveX = rightLimit() ? 0 : BLOCK_UNITY;
		break;
		case 'ArrowLeft':
			// MoveX = leftLimit() || leftOtherPiece() ? 0 : -BLOCK_UNITY;
			MoveX = leftLimit() ? 0 : -BLOCK_UNITY;
		break;
		case 'ArrowUp':
			rotate();
		break;
		default:
		break;
	}
}

document.body.addEventListener('keydown', manageKey);

</script>
</body>
</html>
